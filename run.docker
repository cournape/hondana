# run.docker
FROM deployment-base

ADD . /srv/hondana-git

COPY nginx.conf.in /etc/nginx/sites-available/hondana

RUN apt-get install -qy \
		-o APT::Install-Recommends=false -o APT::Install-Suggests=false \
		nginx supervisor && \
	apt-get clean && \
	sed -e "s|HONDANA_SOURCES|/srv/hondana-git|g" -i /etc/nginx/sites-available/hondana && \
	sed -e "s|HONDANA_STORE|/srv/store|g" -i /etc/nginx/sites-available/hondana && \
	(cd /etc/nginx/sites-enabled && unlink default && ln -s ../sites-available/hondana hondana) && \
	/srv/env/bin/pip install --no-index -f /srv/hondana-git/wheelhouse hondana gunicorn

VOLUME /srv/store
VOLUME /srv/config

COPY supervisor.conf /etc/supervisor/conf.d/hondana.conf

# Run the app
EXPOSE 80
ENV HONDANA_CONFIG /srv/config/config.yaml
CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
